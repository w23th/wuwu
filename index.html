<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>煤矿钻孔瓦斯浓度监测系统222</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <style>
        :root {
            --primary-color: #165DFF;
            --secondary-color: #36CFC9;
            --warning-color: #FF7D00;
            --danger-color: #F53F3F;
            --success-color: #00B42A;
            --dark-bg: #1D2129;
            --card-bg: #282C34;
            --text-primary: #F2F3F5;
            --text-secondary: #C9CDD4;
            --border-radius: 8px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1D2129 0%, #282C34 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .system-title {
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .system-title i {
            color: var(--primary-color);
        }
        
        .system-status {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--success-color);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .filter-section {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
        }
        
        .filter-section:hover {
            transform: translateY(-3px);
        }
        
        .filter-title {
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--secondary-color);
        }
        
        .filter-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .filter-group select, .filter-group input {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .filter-group select:focus, .filter-group input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .btn {
            padding: 9px 18px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0E42D2;
            transform: translateY(-2px);
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(22, 93, 255, 0.1) 0%, rgba(54, 207, 201, 0.1) 100%);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }
        
        .stat-title {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .stat-trend {
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .trend-up {
            color: var(--danger-color);
        }
        
        .trend-down {
            color: var(--success-color);
        }
        
        .charts-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }
        
        .chart-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 25px;
        }
        
        .chart-container {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            height: 350px;
            transition: transform 0.3s ease;
        }
        
        .chart-container:hover {
            transform: translateY(-3px);
        }
        
        .chart-title {
            font-size: 16px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chart-legend {
            display: flex;
            gap: 15px;
            font-size: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }
        
        .tables-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 25px;
        }
        
        .table-container {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        
        .table-title {
            font-size: 16px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .data-table th {
            background-color: rgba(255, 255, 255, 0.03);
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .data-table tr:hover {
            background-color: rgba(255, 255, 255, 0.03);
        }
        
        .data-table tr.high-concentration {
            background-color: rgba(245, 63, 63, 0.1);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(29, 33, 41, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 18px;
            color: var(--text-primary);
        }
        
        .usage-guide {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 25px;
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.8;
        }
        
        .usage-title {
            font-size: 16px;
            color: var(--secondary-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .usage-guide ul {
            margin-left: 20px;
        }
        
        @media (max-width: 1200px) {
            .chart-row {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .tables-section {
                grid-template-columns: 1fr;
            }
            
            .filter-controls {
                grid-template-columns: repeat(2, 1fr);
            }
            
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .system-status {
                width: 100%;
                justify-content: space-between;
            }
        }
        
        @media (max-width: 480px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .filter-controls {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 300px;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .data-table {
                font-size: 12px;
            }
            
            .data-table th, .data-table td {
                padding: 8px 10px;
            }
        }
        
        /* 微信浏览器适配 */
        @supports (-webkit-overflow-scrolling: touch) {
            body {
                padding-bottom: constant(safe-area-inset-bottom);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">加载数据中，请稍候...</div>
    </div>
    
    <div class="container">
        <header>
            <div class="system-title">
                <i class="fas fa-chart-line"></i>
                <span>煤矿钻孔瓦斯浓度监测系统</span>
            </div>
            <div class="system-status">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span>系统运行正常</span>
                </div>
                <div>数据更新时间: <span id="updateTime">2023-06-15 14:30:00</span></div>
                <div>超标钻孔: <span id="overLimitCount" class="trend-up">3</span></div>
            </div>
        </header>
        
        <section class="filter-section">
            <div class="filter-title">
                <i class="fas fa-filter"></i>
                <span>数据筛选</span>
            </div>
            <div class="filter-controls">
                <div class="filter-group">
                    <label for="miningArea">抽采区域</label>
                    <select id="miningArea">
                        <option value="all">全部区域</option>
                        <option value="12802回风巷">12802回风巷</option>
                        <option value="12802运输巷">12802运输巷</option>
                        <option value="12803回风巷">12803回风巷</option>
                        <option value="12803运输巷">12803运输巷</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="drillType">钻孔性质</label>
                    <select id="drillType">
                        <option value="all">全部性质</option>
                        <option value="high">高位钻孔</option>
                        <option value="along">顺层钻孔</option>
                        <option value="through">穿层钻孔</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="extractionUnit">抽采单元</label>
                    <select id="extractionUnit">
                        <option value="all">全部单元</option>
                        <option value="1">一单元</option>
                        <option value="2">二单元</option>
                        <option value="3">三单元</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="displayMode">显示模式</label>
                    <select id="displayMode">
                        <option value="single">单孔显示</option>
                        <option value="group">组显示</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="startDate">开始日期</label>
                    <input type="date" id="startDate" value="2023-06-01">
                </div>
                <div class="filter-group">
                    <label for="endDate">结束日期</label>
                    <input type="date" id="endDate" value="2023-06-15">
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" id="applyFilter">
                    <i class="fas fa-check"></i> 应用筛选
                </button>
                <button class="btn btn-primary" id="resetFilter">
                    <i class="fas fa-sync-alt"></i> 重置
                </button>
            </div>
        </section>
        
        <section class="dashboard">
            <div class="stat-card">
                <div class="stat-title">
                    <i class="fas fa-compress-arrows-alt"></i>
                    <span>平均负压(kPa)</span>
                </div>
                <div class="stat-value">13.8</div>
                <div class="stat-trend trend-up">
                    <i class="fas fa-arrow-up"></i>
                    <span>较昨日上升0.3 kPa</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-title">
                    <i class="fas fa-cloud"></i>
                    <span>平均瓦斯浓度(%)</span>
                </div>
                <div class="stat-value">28.6</div>
                <div class="stat-trend trend-down">
                    <i class="fas fa-arrow-down"></i>
                    <span>较昨日下降1.2%</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-title">
                    <i class="fas fa-wind"></i>
                    <span>平均混合流量(m³/min)</span>
                </div>
                <div class="stat-value">1.26</div>
                <div class="stat-trend trend-up">
                    <i class="fas fa-arrow-up"></i>
                    <span>较昨日上升0.08 m³/min</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-title">
                    <i class="fas fa-bolt"></i>
                    <span>始抽浓度(%)</span>
                </div>
                <div class="stat-value">42.3</div>
                <div class="stat-trend trend-down">
                    <i class="fas fa-arrow-down"></i>
                    <span>较昨日下降0.5%</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-title">
                    <i class="fas fa-arrow-up"></i>
                    <span>历史最高浓度(%)</span>
                </div>
                <div class="stat-value">89.7</div>
                <div class="stat-trend">
                    <i class="fas fa-calendar-alt"></i>
                    <span>记录于2023-06-10</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-title">
                    <i class="fas fa-arrow-down"></i>
                    <span>历史最低浓度(%)</span>
                </div>
                <div class="stat-value">5.2</div>
                <div class="stat-trend">
                    <i class="fas fa-calendar-alt"></i>
                    <span>记录于2023-06-02</span>
                </div>
            </div>
        </section>
        
        <section class="charts-section">
            <div class="chart-row">
                <div class="chart-container">
                    <div class="chart-title">
                        <span>负压变化曲线</span>
                        <div class="chart-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #165DFF;"></div>
                                <span>负压值</span>
                            </div>
                        </div>
                    </div>
                    <canvas id="pressureChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">
                        <span>瓦斯浓度变化曲线</span>
                        <div class="chart-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #36CFC9;"></div>
                                <span>瓦斯浓度</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #FF7D00;"></div>
                                <span>警戒线(30%)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #F53F3F;"></div>
                                <span>严重超标线(85%)</span>
                            </div>
                        </div>
                    </div>
                    <canvas id="gasConcentrationChart"></canvas>
                </div>
            </div>
            <div class="chart-row">
                <div class="chart-container">
                    <div class="chart-title">
                        <span>混合流量变化曲线</span>
                        <div class="chart-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #722ED1;"></div>
                                <span>混合流量</span>
                            </div>
                        </div>
                    </div>
                    <canvas id="flowRateChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">
                        <span>高浓度钻孔倾角分布</span>
                        <div class="chart-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #165DFF;"></div>
                                <span>0-30°</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #36CFC9;"></div>
                                <span>30-60°</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #FF7D00;"></div>
                                <span>60-90°</span>
                            </div>
                        </div>
                    </div>
                    <canvas id="dipAngleChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">
                    <span>高浓度钻孔占比</span>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #00B42A;"></div>
                            <span>正常(&lt;30%)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #FF7D00;"></div>
                            <span>超标(30%-85%)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #F53F3F;"></div>
                            <span>严重超标(&gt;85%)</span>
                        </div>
                    </div>
                </div>
                <canvas id="concentrationRatioChart"></canvas>
            </div>
        </section>
        
        <section class="tables-section">
            <div class="table-container">
                <div class="table-title">
                    <i class="fas fa-table"></i>
                    <span>钻孔详细数据</span>
                </div>
                <table class="data-table" id="drillDetailsTable">
                    <thead>
                        <tr>
                            <th>检测日期</th>
                            <th>钻孔编号</th>
                            <th>方位(°)</th>
                            <th>倾角(°)</th>
                            <th>长度(m)</th>
                            <th>负压(kPa)</th>
                            <th>瓦斯浓度(%)</th>
                            <th>混合流量(m³/min)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 表格数据将通过JavaScript动态填充 -->
                    </tbody>
                </table>
            </div>
            <div class="table-container">
                <div class="table-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>高浓度钻孔预警</span>
                </div>
                <table class="data-table" id="highConcentrationTable">
                    <thead>
                        <tr>
                            <th>检测日期</th>
                            <th>钻孔编号</th>
                            <th>所在区域</th>
                            <th>瓦斯浓度(%)</th>
                            <th>超标类型</th>
                            <th>处理状态</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 表格数据将通过JavaScript动态填充 -->
                    </tbody>
                </table>
            </div>
        </section>
        
        <section class="usage-guide">
            <div class="usage-title">
                <i class="fas fa-info-circle"></i>
                <span>系统使用说明</span>
            </div>
            <ul>
                <li>通过顶部筛选条件可以按区域、钻孔性质等筛选数据</li>
                <li>图表区域展示了各类监测数据的变化趋势，点击图例可隐藏/显示对应数据</li>
                <li>瓦斯浓度超过30%的钻孔会在表格中高亮显示，超过85%会标记为严重超标</li>
                <li>数据每30分钟自动更新一次，也可点击"应用筛选"手动刷新</li>
                <li>高浓度钻孔预警表实时显示需要关注的钻孔信息</li>
            </ul>
        </section>
    </div>

    <script>
        // 全局数据存储
        let allDrillData = [];
        let filteredDrillData = [];
        let allTimeLabels = [];
        const CSV_FILE_PATH = 'drill_data.csv';
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 模拟数据加载
            simulateDataLoading();
            
            // 绑定筛选按钮事件
            document.getElementById('applyFilter').addEventListener('click', applyFilter);
            document.getElementById('resetFilter').addEventListener('click', resetFilter);
        });
        
        // 模拟数据加载
        function simulateDataLoading() {
            // 生成时间标签（过去15天，每2小时一个点）
            const days = 15;
            const hoursPerDay = 12; // 每天12个数据点
            for (let d = 0; d < days; d++) {
                for (let h = 0; h < hoursPerDay; h++) {
                    const date = new Date();
                    date.setDate(date.getDate() - (days - d));
                    date.setHours(h * 2, 0, 0, 0);
                    allTimeLabels.push(date.toLocaleString());
                }
            }
            
            // 生成模拟钻孔数据
            const drillIds = ['ZK-12802-01', 'ZK-12802-02', 'ZK-12802-03', 'ZK-12802-04', 
                             'ZK-12802-05', 'ZK-12803-01', 'ZK-12803-02', 'ZK-12803-03'];
            const areas = ['12802回风巷', '12802运输巷', '12803回风巷', '12803运输巷'];
            const types = ['high', 'along', 'through'];
            const units = ['1', '2', '3'];
            
            drillIds.forEach(drillId => {
                // 为每个钻孔生成随机数据，包含一些缺失值
                const areaIndex = Math.floor(Math.random() * areas.length);
                const typeIndex = Math.floor(Math.random() * types.length);
                const unitIndex = Math.floor(Math.random() * units.length);
                const azimuth = 100 + Math.floor(Math.random() * 50);
                const dipAngle = Math.floor(Math.random() * 90);
                const length = 60 + Math.floor(Math.random() * 40);
                
                // 随机生成数据点，不是每个时间点都有数据
                for (let i = 0; i < allTimeLabels.length; i++) {
                    // 30%的概率跳过该时间点（模拟数据缺失）
                    if (Math.random() < 0.3) continue;
                    
                    // 生成基础值并添加随机波动
                    let basePressure = 13 + Math.random() * 2;
                    let baseConcentration = 20 + Math.random() * 30;
                    let baseFlow = 1 + Math.random() * 0.5;
                    
                    // 随时间添加一些趋势变化
                    const dayFactor = i / (hoursPerDay * 2);
                    baseConcentration += Math.sin(dayFactor) * 5;
                    
                    allDrillData.push({
                        time: allTimeLabels[i],
                        drillId: drillId,
                        area: areas[areaIndex],
                        type: types[typeIndex],
                        unit: units[unitIndex],
                        azimuth: azimuth,
                        dipAngle: dipAngle,
                        length: length,
                        pressure: parseFloat(basePressure.toFixed(1)),
                        concentration: parseFloat(baseConcentration.toFixed(1)),
                        flow: parseFloat(baseFlow.toFixed(2))
                    });
                }
            });
            
            // 初始化筛选后的数据
            filteredDrillData = [...allDrillData];
            
            // 初始化图表和表格
            initCharts();
            updateTables();
            
            // 隐藏加载界面
            setTimeout(() => {
                document.getElementById('loadingOverlay').style.opacity = 0;
                setTimeout(() => {
                    document.getElementById('loadingOverlay').style.display = 'none';
                }, 500);
            }, 1500);
        }
        
        // 应用筛选条件
        function applyFilter() {
            const miningArea = document.getElementById('miningArea').value;
            const drillType = document.getElementById('drillType').value;
            const extractionUnit = document.getElementById('extractionUnit').value;
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            endDate.setHours(23, 59, 59, 999); // 设置为当天结束时间
            
            // 更新加载状态
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('loadingOverlay').style.opacity = 1;
            
            // 筛选数据
            filteredDrillData = allDrillData.filter(item => {
                const itemDate = new Date(item.time);
                
                // 区域筛选
                if (miningArea !== 'all' && item.area !== miningArea) return false;
                
                // 钻孔性质筛选
                if (drillType !== 'all' && item.type !== drillType) return false;
                
                // 抽采单元筛选
                if (extractionUnit !== 'all' && item.unit !== extractionUnit) return false;
                
                // 日期范围筛选
                if (itemDate < startDate || itemDate > endDate) return false;
                
                return true;
            });
            
            // 重新初始化图表和表格
            setTimeout(() => {
                initCharts();
                updateTables();
                
                // 更新数据时间
                const now = new Date();
                document.getElementById('updateTime').textContent = now.toLocaleString();
                
                // 隐藏加载界面
                document.getElementById('loadingOverlay').style.opacity = 0;
                setTimeout(() => {
                    document.getElementById('loadingOverlay').style.display = 'none';
                }, 500);
            }, 800);
        }
        
        // 重置筛选条件
        function resetFilter() {
            document.getElementById('miningArea').value = 'all';
            document.getElementById('drillType').value = 'all';
            document.getElementById('extractionUnit').value = 'all';
            document.getElementById('startDate').value = '2023-06-01';
            document.getElementById('endDate').value = '2023-06-15';
            
            applyFilter();
        }
        
        // 初始化所有图表
        function initCharts() {
            initPressureChart();
            initGasConcentrationChart();
            initFlowRateChart();
            initDipAngleChart();
            initConcentrationRatioChart();
        }
        
        // 初始化负压变化曲线
        function initPressureChart() {
            const ctx = document.getElementById('pressureChart').getContext('2d');
            
            // 按钻孔聚合数据，缺失值用null填充
            const processedData = processDrillData('pressure');
            
            // 转换为数据集
            const datasets = Object.values(processedData).map(dataset => ({
                ...dataset,
                borderColor: dataset.borderColor,
                backgroundColor: 'transparent'
            }));
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allTimeLabels,
                    datasets: datasets
                },
                options: getChartOptions('负压(kPa)')
            });
        }
        
        // 初始化瓦斯浓度变化曲线 - 修复了图例重复问题
        function initGasConcentrationChart() {
            const ctx = document.getElementById('gasConcentrationChart').getContext('2d');
            
            // 按钻孔聚合数据，确保每个钻孔只生成一个数据集
            const processedData = processDrillData('concentration');
            
            // 转换为数据集数组（确保每个钻孔只出现一次）
            const datasets = Object.values(processedData).map(dataset => {
                // 填充数组中未定义的位置（缺失数据）为null
                dataset.data = dataset.data.map(val => val ?? null);
                
                // 为有缺失数据的钻孔添加视觉标记
                const hasNull = dataset.data.some(val => val === null);
                if (hasNull) {
                    dataset.borderDash = [5, 5]; // 虚线表示有缺失数据
                }
                
                return dataset;
            });
            
            // 创建图表
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allTimeLabels,
                    datasets: datasets
                },
                options: {
                    ...getChartOptions('瓦斯浓度(%)'),
                    plugins: {
                        ...getChartOptions('瓦斯浓度(%)').plugins,
                        annotation: {
                            annotations: {
                                line1: {
                                    type: 'line',
                                    yMin: 30,
                                    yMax: 30,
                                    borderColor: '#FF7D00',
                                    borderWidth: 2,
                                    borderDash: [5, 5]
                                },
                                line2: {
                                    type: 'line',
                                    yMin: 85,
                                    yMax: 85,
                                    borderColor: '#F53F3F',
                                    borderWidth: 2
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 初始化混合流量变化曲线
        function initFlowRateChart() {
            const ctx = document.getElementById('flowRateChart').getContext('2d');
            
            // 按钻孔聚合数据
            const processedData = processDrillData('flow');
            
            // 转换为数据集
            const datasets = Object.values(processedData).map(dataset => ({
                ...dataset,
                borderColor: dataset.borderColor,
                backgroundColor: 'transparent'
            }));
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allTimeLabels,
                    datasets: datasets
                },
                options: getChartOptions('混合流量(m³/min)')
            });
        }
        
        // 初始化倾角分布饼图
        function initDipAngleChart() {
            const ctx = document.getElementById('dipAngleChart').getContext('2d');
            
            // 统计高浓度钻孔的倾角分布
            const highConcentrationDrills = [...new Set(
                filteredDrillData
                    .filter(item => item.concentration > 30)
                    .map(item => item.drillId)
            )];
            
            // 获取这些钻孔的倾角信息
            const dipAngleData = {
                '0-30°': 0,
                '30-60°': 0,
                '60-90°': 0
            };
            
            highConcentrationDrills.forEach(drillId => {
                const drill = filteredDrillData.find(item => item.drillId === drillId);
                if (drill) {
                    if (drill.dipAngle <= 30) {
                        dipAngleData['0-30°']++;
                    } else if (drill.dipAngle <= 60) {
                        dipAngleData['30-60°']++;
                    } else {
                        dipAngleData['60-90°']++;
                    }
                }
            });
            
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(dipAngleData),
                    datasets: [{
                        data: Object.values(dipAngleData),
                        backgroundColor: ['#165DFF', '#36CFC9', '#FF7D00'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }
        
        // 初始化浓度占比饼图
        function initConcentrationRatioChart() {
            const ctx = document.getElementById('concentrationRatioChart').getContext('2d');
            
            // 统计不同浓度范围的钻孔数量
            const uniqueDrills = [...new Set(filteredDrillData.map(item => item.drillId))];
            const ratioData = {
                '正常(<30%)': 0,
                '超标(30%-85%)': 0,
                '严重超标(>85%)': 0
            };
            
            uniqueDrills.forEach(drillId => {
                const drillData = filteredDrillData.filter(item => item.drillId === drillId);
                const maxConcentration = Math.max(...drillData.map(item => item.concentration));
                
                if (maxConcentration <= 30) {
                    ratioData['正常(<30%)']++;
                } else if (maxConcentration <= 85) {
                    ratioData['超标(30%-85%)']++;
                } else {
                    ratioData['严重超标(>85%)']++;
                }
            });
            
            // 更新超标计数
            document.getElementById('overLimitCount').textContent = 
                ratioData['超标(30%-85%)'] + ratioData['严重超标(>85%)'];
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(ratioData),
                    datasets: [{
                        data: Object.values(ratioData),
                        backgroundColor: ['#00B42A', '#FF7D00', '#F53F3F'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    },
                    cutout: '65%'
                }
            });
        }
        
        // 处理钻孔数据，按钻孔ID聚合并填充缺失值
        function processDrillData(valueKey) {
            const processedData = {};
            
            filteredDrillData.forEach(item => {
                const drillId = item.drillId;
                if (!processedData[drillId]) {
                    // 为每个钻孔创建唯一数据集
                    processedData[drillId] = {
                        label: `钻孔 ${drillId}`, // 唯一图例标签
                        data: new Array(allTimeLabels.length).fill(null), // 初始化数组，用null填充
                        borderColor: getColorByDrill(drillId), // 保持颜色唯一
                        fill: false,
                        tension: 0.1,
                        pointRadius: 2,
                        pointHoverRadius: 5
                    };
                }
                
                // 找到时间对应的索引并设置值
                const timeIndex = allTimeLabels.indexOf(item.time);
                if (timeIndex !== -1) {
                    processedData[drillId].data[timeIndex] = item[valueKey];
                }
            });
            
            return processedData;
        }
        
        // 根据钻孔ID生成唯一颜色
        function getColorByDrill(drillId) {
            // 使用哈希函数根据drillId生成一致的颜色
            let hash = 0;
            for (let i = 0; i < drillId.length; i++) {
                hash = ((hash << 5) - hash) + drillId.charCodeAt(i);
                hash |= 0; // 转换为32位整数
            }
            
            // 从哈希值生成RGB颜色
            const colors = [
                '#165DFF', '#36CFC9', '#722ED1', '#FF7D00', '#F53F3F', 
                '#FF9A2E', '#0FC6C2', '#7BC616', '#F7BA1E', '#14C9C9'
            ];
            
            // 确保相同drillId始终得到相同颜色
            return colors[Math.abs(hash) % colors.length];
        }
        
        // 获取时间索引
        function getTimeIndex(timeStr) {
            return allTimeLabels.indexOf(timeStr);
        }
        
        // 获取通用图表配置
        function getChartOptions(yAxisTitle) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        ticks: {
                            autoSkip: true,
                            maxRotation: 0,
                            color: 'rgba(201, 205, 212, 0.7)'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.05)'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: yAxisTitle,
                            color: 'rgba(201, 205, 212, 0.9)'
                        },
                        ticks: {
                            color: 'rgba(201, 205, 212, 0.7)'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.05)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: 'rgba(242, 243, 245, 0.9)',
                            boxWidth: 12,
                            padding: 15
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(40, 44, 52, 0.9)',
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1,
                        padding: 10,
                        titleColor: 'rgba(242, 243, 245, 0.9)',
                        bodyColor: 'rgba(242, 243, 245, 0.7)',
                        callbacks: {
                            title: function(tooltipItems) {
                                return tooltipItems[0].label;
                            }
                        }
                    }
                },
                // 关键配置：处理空值，不连接线段但保持唯一图例
                spanGaps: false,
                elements: {
                    line: {
                        connectNulls: false // 不连接空值
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            };
        }
        
        // 更新表格数据
        function updateTables() {
            updateDrillDetailsTable();
            updateHighConcentrationTable();
        }
        
        // 更新钻孔详细数据表
        function updateDrillDetailsTable() {
            const tableBody = document.getElementById('drillDetailsTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            
            // 获取最新的钻孔数据
            const latestData = getLatestDrillData();
            
            // 只显示前10条记录
            const displayData = latestData.slice(0, 10);
            
            displayData.forEach(item => {
                const row = document.createElement('tr');
                
                // 高浓度钻孔高亮显示
                if (item.concentration > 30) {
                    row.classList.add('high-concentration');
                }
                
                row.innerHTML = `
                    <td>${item.time}</td>
                    <td>${item.drillId}</td>
                    <td>${item.azimuth}</td>
                    <td>${item.dipAngle}</td>
                    <td>${item.length}</td>
                    <td>${item.pressure}</td>
                    <td>${item.concentration}</td>
                    <td>${item.flow}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // 更新高浓度钻孔预警表
        function updateHighConcentrationTable() {
            const tableBody = document.getElementById('highConcentrationTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            
            // 获取最新的钻孔数据
            const latestData = getLatestDrillData();
            
            // 筛选出高浓度钻孔
            const highConcentrationData = latestData
                .filter(item => item.concentration > 30)
                .sort((a, b) => b.concentration - a.concentration);
            
            highConcentrationData.forEach(item => {
                const row = document.createElement('tr');
                let overLimitType = '超标';
                let typeClass = 'trend-up';
                
                if (item.concentration > 85) {
                    overLimitType = '严重超标';
                    typeClass = 'trend-up';
                }
                
                row.innerHTML = `
                    <td>${item.time}</td>
                    <td>${item.drillId}</td>
                    <td>${item.area}</td>
                    <td class="${typeClass}">${item.concentration}</td>
                    <td class="${typeClass}">${overLimitType}</td>
                    <td>未处理</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // 获取每个钻孔的最新数据
        function getLatestDrillData() {
            const latestDataMap = {};
            
            filteredDrillData.forEach(item => {
                const drillId = item.drillId;
                const itemDate = new Date(item.time);
                
                // 只保留每个钻孔的最新数据
                if (!latestDataMap[drillId] || 
                    new Date(latestDataMap[drillId].time) < itemDate) {
                    latestDataMap[drillId] = item;
                }
            });
            
            // 转换为数组并按时间排序
            return Object.values(latestDataMap)
                .sort((a, b) => new Date(b.time) - new Date(a.time));
        }
    </script>
</body>
</html>
