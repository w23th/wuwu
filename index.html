<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>营脚煤矿钻孔数据分析系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        /* 样式保持不变 */
    </style>
</head>
<body>
    <!-- 系统加载状态 -->
    <div class="system-loading" id="system-loading">
        <div class="loading-spinner"></div>
        <h2>营脚煤矿数据分析系统初始化中...</h2>
        <div class="progress-bar">
            <div class="progress" id="loading-progress"></div>
        </div>
    </div>
    
    <!-- 系统状态指示器 -->
    <div class="system-status-indicator" id="status-indicator">
        <div class="status-indicator" id="status-indicator-icon"></div>
        <span id="status-text">系统就绪</span>
    </div>
    
    <div class="container">
        <!-- 页面内容保持不变 -->
    </div>

    <script>
        // ... 前面的代码保持不变 ...
        
        // 更新图表 - 支持虚线连接缺失数据点
        function updateCharts(dataToDisplay, startDate, endDate) {
            const ctx1 = document.getElementById('pressure-chart').getContext('2d');
            const ctx2 = document.getElementById('concentration-chart').getContext('2d');
            const ctx3 = document.getElementById('flow-chart').getContext('2d');
            
            // 销毁旧图表
            if (pressureChart) pressureChart.destroy();
            if (concentrationChart) concentrationChart.destroy();
            if (flowChart) flowChart.destroy();
            
            // 清空图例
            pressureLegend.innerHTML = '';
            concentrationLegend.innerHTML = '';
            flowLegend.innerHTML = '';
            
            // 准备图表数据
            const pressureDatasets = [];
            const concentrationDatasets = [];
            const flowDatasets = [];
            
            const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f1c40f', '#9b59b6', '#1abc9c'];
            const drillIds = new Set(); // 用于跟踪已添加的钻孔ID
            
            // 确定X轴日期序列（使用日期最全的钻孔）
            let commonDates = [];
            
            if (dataToDisplay.length > 0) {
                // 找出日期最全的钻孔
                let maxDateDrill = dataToDisplay[0];
                let maxDateCount = maxDateDrill.dates.length;
                
                for (let i = 1; i < dataToDisplay.length; i++) {
                    if (dataToDisplay[i].dates.length > maxDateCount) {
                        maxDateDrill = dataToDisplay[i];
                        maxDateCount = maxDateDrill.dates.length;
                    }
                }
                
                // 使用日期最全的钻孔的日期序列作为X轴基础
                commonDates = maxDateDrill.dates;
            }
            
            dataToDisplay.forEach((drill, index) => {
                // 检查是否已添加此钻孔的标识
                const drillId = drill['钻孔编号'];
                if (drillIds.has(drillId)) {
                    return; // 已经添加过此钻孔，跳过
                }
                drillIds.add(drillId);
                
                // 创建数据映射（日期 -> 值）
                const pressureMap = new Map();
                const concentrationMap = new Map();
                const flowMap = new Map();
                
                // 填充映射
                drill.dates.forEach((date, idx) => {
                    pressureMap.set(date, drill.pressure[idx]);
                    concentrationMap.set(date, drill.concentration[idx]);
                    flowMap.set(date, drill.flow[idx]);
                });
                
                // 根据commonDates创建数据序列
                const pressureData = [];
                const concentrationData = [];
                const flowData = [];
                
                commonDates.forEach(date => {
                    pressureData.push(pressureMap.has(date) ? pressureMap.get(date) : null);
                    concentrationData.push(concentrationMap.has(date) ? concentrationMap.get(date) : null);
                    flowData.push(flowMap.has(date) ? flowMap.get(date) : null);
                });
                
                // 计算浓度图表y轴范围
                const concentrationRange = concentrationData.length > 0 ? 
                    calculateConcentrationYAxisRange(concentrationData) : 
                    { min: 0, max: 5 };
                
                // 更新范围信息
                concentrationRangeInfo.textContent = `Y轴范围: ${concentrationRange.min.toFixed(2)}% - ${concentrationRange.max.toFixed(2)}%`;
                
                // 创建虚线数据集
                const createSegmentedDataset = (data, color, label) => {
                    const segments = [];
                    let currentSegment = {
                        data: [],
                        borderColor: color,
                        backgroundColor: `rgba(${parseInt(color.slice(1, 3), 16)}, ${parseInt(color.slice(3, 5), 16)}, ${parseInt(color.slice(5, 7), 16)}, 0.1)`,
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: '#fff',
                        pointBorderWidth: 1,
                        tension: 0.2,
                        fill: false,
                        label: label
                    };
                    
                    let lastNonNullIndex = -1;
                    
                    // 处理数据点，创建分段数据集
                    for (let i = 0; i < data.length; i++) {
                        const value = data[i];
                        
                        if (value === null) {
                            // 如果当前值为空，结束当前线段（如果有数据）
                            if (currentSegment.data.length > 0) {
                                segments.push(currentSegment);
                                currentSegment = {
                                    data: [],
                                    borderColor: '#888',
                                    backgroundColor: 'rgba(136, 136, 136, 0.1)',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    pointRadius: 0,
                                    tension: 0.2,
                                    fill: false,
                                    label: '' // 不显示图例标签
                                };
                            }
                            
                            // 如果前一个非空值存在，添加到虚线线段
                            if (lastNonNullIndex >= 0) {
                                currentSegment.data.push({
                                    x: commonDates[lastNonNullIndex],
                                    y: data[lastNonNullIndex]
                                });
                            }
                        } else {
                            // 当前值非空
                            lastNonNullIndex = i;
                            
                            // 如果当前是虚线线段，且已有数据点，结束当前虚线线段
                            if (currentSegment.borderDash && currentSegment.data.length > 0) {
                                // 添加当前点作为虚线终点
                                currentSegment.data.push({
                                    x: commonDates[i],
                                    y: value
                                });
                                segments.push(currentSegment);
                                currentSegment = {
                                    data: [],
                                    borderColor: color,
                                    backgroundColor: `rgba(${parseInt(color.slice(1, 3), 16)}, ${parseInt(color.slice(3, 5), 16)}, ${parseInt(color.slice(5, 7), 16)}, 0.1)`,
                                    borderWidth: 2,
                                    pointRadius: 4,
                                    pointBackgroundColor: '#fff',
                                    pointBorderWidth: 1,
                                    tension: 0.2,
                                    fill: false,
                                    label: '' // 虚线部分不显示标签
                                };
                            }
                            
                            // 添加当前点到当前线段
                            currentSegment.data.push({
                                x: commonDates[i],
                                y: value
                            });
                        }
                    }
                    
                    // 添加最后一个线段
                    if (currentSegment.data.length > 0) {
                        segments.push(currentSegment);
                    }
                    
                    return segments;
                };
                
                // 添加数据集
                pressureDatasets.push(
                    ...createSegmentedDataset(
                        pressureData, 
                        colors[index % colors.length], 
                        `${drill['钻孔编号']} 负压`
                    )
                );
                
                concentrationDatasets.push(
                    ...createSegmentedDataset(
                        concentrationData, 
                        colors[index % colors.length], 
                        `${drill['钻孔编号']} 浓度`
                    )
                );
                
                flowDatasets.push(
                    ...createSegmentedDataset(
                        flowData, 
                        colors[index % colors.length], 
                        `${drill['钻孔编号']} 流量`
                    )
                );
                
                // 添加图例项
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `
                    <div class="legend-color" style="background: ${colors[index % colors.length]}"></div>
                    <span>${drill['钻孔编号']}</span>
                `;
                pressureLegend.appendChild(legendItem.cloneNode(true));
                concentrationLegend.appendChild(legendItem.cloneNode(true));
                flowLegend.appendChild(legendItem.cloneNode(true));
            });
            
            // 创建新图表
            if (pressureDatasets.length > 0) {
                pressureChart = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: commonDates,
                        datasets: pressureDatasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false // 禁用内置图例
                            },
                            tooltip: {
                                backgroundColor: 'rgba(44, 62, 80, 0.9)',
                                bodyFont: {
                                    size: 12
                                },
                                padding: 10
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: '#a0a0a0',
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            },
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: '负压（KPa）',
                                    font: {
                                        size: 12,
                                        weight: 'bold'
                                    },
                                    color: '#f0f0f0'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.05)'
                                },
                                ticks: {
                                    color: '#a0a0a0'
                                }
                            }
                        },
                        animation: {
                            duration: 800,
                            easing: 'easeOutQuart'
                        }
                    }
                });
                
                concentrationChart = new Chart(ctx2, {
                    type: 'line',
                    data: {
                        labels: commonDates,
                        datasets: concentrationDatasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false // 禁用内置图例
                            },
                            tooltip: {
                                backgroundColor: 'rgba(44, 62, 80, 0.9)',
                                bodyFont: {
                                    size: 12
                                },
                                padding: 10
                            },
                            annotation: {
                                annotations: {
                                    line1: {
                                        type: 'line',
                                        yMin: 85,
                                        yMax: 85,
                                        borderColor: 'rgba(231, 76, 60, 0.7)',
                                        borderWidth: 1,
                                        borderDash: [5, 5],
                                        label: {
                                            display: true,
                                            content: '严重超标警戒线',
                                            position: 'end',
                                            backgroundColor: 'rgba(231, 76, 60, 0.7)',
                                            font: {
                                                size: 10
                                            }
                                        }
                                    },
                                    line2: {
                                        type: 'line',
                                        yMin: 30,
                                        yMax: 30,
                                        borderColor: 'rgba(241, 196, 15, 0.7)',
                                        borderWidth: 1,
                                        borderDash: [5, 5],
                                        label: {
                                            display: true,
                                            content: '警戒线',
                                            position: 'end',
                                            backgroundColor: 'rgba(241, 196, 15, 0.7)',
                                            font: {
                                                size: 10
                                            }
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: '#a0a0a0',
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            },
                            y: {
                                min: 0,
                                max: 100,
                                title: {
                                    display: true,
                                    text: '瓦斯浓度（%）',
                                    font: {
                                        size: 12,
                                        weight: 'bold'
                                    },
                                    color: '#f0f0f0'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.05)'
                                },
                                ticks: {
                                    color: '#a0a0a0'
                                }
                            }
                        },
                        animation: {
                            duration: 800,
                            easing: 'easeOutQuart'
                        }
                    }
                });
                
                flowChart = new Chart(ctx3, {
                    type: 'line',
                    data: {
                        labels: commonDates,
                        datasets: flowDatasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false // 禁用内置图例
                            },
                            tooltip: {
                                backgroundColor: 'rgba(44, 62, 80, 0.9)',
                                bodyFont: {
                                    size: 12
                                },
                                padding: 10
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: '#a0a0a0',
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            },
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: '混合流量（m³/min）',
                                    font: {
                                        size: 12,
                                        weight: 'bold'
                                    },
                                    color: '#f0f0f0'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.05)'
                                },
                                ticks: {
                                    color: '#a0a0a0'
                                }
                            }
                        },
                        animation: {
                            duration: 800,
                            easing: 'easeOutQuart'
                        }
                    }
                });
            } else {
                // 没有数据时清除画布
                ctx1.clearRect(0, 0, ctx1.canvas.width, ctx1.canvas.height);
                ctx2.clearRect(0, 0, ctx2.canvas.width, ctx2.canvas.height);
                ctx3.clearRect(0, 0, ctx3.canvas.width, ctx3.canvas.height);
                
                // 显示无数据消息
                ctx1.font = '14px Arial';
                ctx1.fillStyle = '#a0d2ff';
                ctx1.textAlign = 'center';
                ctx1.fillText('无数据', ctx1.canvas.width/2, ctx1.canvas.height/2);
                
                ctx2.font = '14px Arial';
                ctx2.fillStyle = '#a0d2ff';
                ctx2.textAlign = 'center';
                ctx2.fillText('无数据', ctx2.canvas.width/2, ctx2.canvas.height/2);
                
                ctx3.font = '14px Arial';
                ctx3.fillStyle = '#a0d2ff';
                ctx3.textAlign = 'center';
                ctx3.fillText('无数据', ctx3.canvas.width/2, ctx3.canvas.height/2);
            }
        }
        
        // 页面加载时初始化
        window.addEventListener('load', initializePage);
    </script>
</body>
</html>
